language: csharp
solution: PersistentScienceCollectorAI.sln

env:
 - KSP_VERSION="1.5.1"
 - KSP_VERSION="1.4.5"

stages:
  - name: test
  - name: deploy
    if: tag IS present

before_install:
 - sudo apt-get update -qq
 - sudo apt-get install -qq p7zip-full bash openssh-client jq
script:
 - mkdir -p ../../KSP_x64_Data/Managed/
 - wget https://img.spaceball.cf/KSP-$KSP_VERSION.7z
 - 7za x KSP-$KSP_VERSION.7z -o../../KSP_x64_Data/Managed/ -p$ZIP_PASSWORD
 - rm -rf KSP-$KSP_VERSION.7z
 - msbuild /p:Configuration=Release /p:PostBuildEvent= PersistentScienceCollectorAI.sln
 - mkdir -p GameData/PersistentScienceCollectorAI/Plugin/
 - mv Plugin/PersistentScienceCollectorAI.dll GameData/PersistentScienceCollectorAI/Plugin/
 - mv Parts.cfg GameData/PersistentScienceCollectorAI
 - mv Localization/ GameData/PersistentScienceCollectorAI/
 - mv icon.png GameData/PersistentScienceCollectorAI/
 - sh travisVersion.sh
 - tail PersistentScienceCollectorAI.version
 - mv PersistentScienceCollectorAI.version GameData/PersistentScienceCollectorAI/
 - mv PersistentScienceCollectorAI.netkan GameData/PersistentScienceCollectorAI/
 - zip -r PersistentScienceCollectorAI-$TRAVIS_BRANCH.zip GameData/PersistentScienceCollectorAI/
 - mkdir $KSP_VERSION
 - mv PersistentScienceCollectorAI-$TRAVIS_BRANCH.zip $KSP_VERSION/

jobs:
 include:
 - stage: deploy
   env: KSP_VERSION="1.5.1"
   deploy:
     provider: releases
     api_key:
       secure: $GITHUB_TOKEN
     file: $KSP_VERSION/PersistentScienceCollectorAI-$TRAVIS_BRANCH.zip
     skip_cleanup: true
     on:
       tags: true
       repo: Seretos/PersistentScienceCollectorAI
#jobs:
#  include:
#    - stage: build
#	  env:
#	    - KSP_VERSION="1.5.1"
#	- stage: deploy
